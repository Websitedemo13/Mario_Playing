<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escape The Scam</title>
    <!-- Đảm bảo đường dẫn đến style.css là đúng -->
    <link href="Content/style.css" rel="stylesheet" />
    <!-- Đảm bảo đường dẫn đến favicon là đúng -->
    <link rel="icon" type="image/png" href="Content/favicon.png"> 
    <style>
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; touch-action: manipulation; }
        #game { image-rendering: pixelated; image-rendering: crisp-edges; }
    </style>
</head>
<body>

    <!-- Giao diện Quiz Pop-up (Giữ nguyên HTML, CSS sẽ xử lý) -->
    <div id="quiz-overlay" class="hidden">
        <div id="quiz-box">
            <p id="quiz-question">Câu hỏi?</p>
            <div id="quiz-options">
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
            </div>
            <p id="quiz-explanation" class="hidden"></p>
            <button id="quiz-continue-btn" class="hidden">Tiếp tục</button>
        </div>
    </div>

    <!-- Màn hình Đăng nhập (Giữ nguyên HTML) -->
    <div id="login-screen">
        <div id="login-container">
            <div id="login-info" class="login-column">
                <!-- Đảm bảo đường dẫn  đúng -->
                <img id="ueh-logo" src="Content/logo/KQM.png" alt="Logo" onerror="this.src='https://placehold.co/150x50/000000/0f0?text=Logo+Error'"> <!-- Thêm fallback -->
                <h3>Luật Chơi "Escape The Scam"</h3>
                <ul id="game-rules">
                    <li>Dùng ◀ ▶ / phím mũi tên để di chuyển.</li>
                    <li>Dùng Ⓐ / phím Lên để nhảy.</li>
                    <li>Tránh 'Scammer'.</li>
                    <li>Húc vào hộp [?] để trả lời câu hỏi.</li>
                    <li>Trả lời sai sẽ bị trừ 1 mạng!</li>
                </ul>
            </div>
            <div id="login-box" class="login-column">
                <h2>Vào Game</h2>
                <p>Nhập thông tin (UEH Student)</p>
                <input type="text" id="input-name" placeholder="Họ và tên..." autocomplete="off">
                <input type="text" id="input-mssv" placeholder="MSSV..." autocomplete="off">
                <button id="login-button">Bắt đầu</button>
            </div>
        </div>
    </div>

    <!-- Game (Giữ nguyên HTML) -->
    <div id="game" class="hidden">
        <div id="world"></div>
        <div id="coinNumber" class="gauge">0</div>
        <div id="coin" class="gaugeSprite"></div>
        <div id="liveNumber" class="gauge">0</div>
        <div id="live" class="gaugeSprite"></div>
        <div id="playerName" class="gauge gauge-text"></div>
        <div id="playerMSSV" class="gauge gauge-text"></div>
    </div>

    <!-- Joystick (Giữ nguyên HTML) -->
    <div id="mobile-controls" class="hidden">
        <div id="dpad"> <button id="btn-left">◀</button> <button id="btn-right">▶</button> </div>
        <div id="action-buttons"> <button id="btn-jump">Ⓐ</button> </div>
    </div>

    <!-- Audio (Giữ nguyên HTML, đảm bảo file nhạc tồn tại) -->
    <audio id="game-music" loop>
         <source src="Content/audio/background-music.mp3" type="audio/mpeg"> 
         Trình duyệt không hỗ trợ âm thanh.
    </audio>

    <!-- === THỨ TỰ SCRIPT ĐÃ SỬA === -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="Scripts/jQuery.js"><\/script>')</script>
    
    <script src="Scripts/oop.js"></script> <!-- Class.extend phải chạy TRƯỚC main.js -->
    <script src="Scripts/constants.js"></script> 
    <script src="Scripts/questions.js"></script> 
    
    <script src="Scripts/main.js"></script> <!-- Class game, cần Class, questions, constants -->
    
    <script src="Scripts/testlevels.js"></script> <!-- Dữ liệu màn chơi, cần các Class trong main.js -->
    <script src="Scripts/keys.js"></script> <!-- Xử lý Input -->
    <!-- ============================= -->

    <!-- Script chính (Login, Quiz, Joystick, Game Over - Giữ nguyên logic) -->
    <script>
    // --- Khai báo biến toàn cục cho game ---
    var level = null; // Biến này sẽ được khởi tạo trong initGame

    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const gameDiv = document.getElementById('game');
        const gameMusic = document.getElementById('game-music'); 
        const inputName = document.getElementById('input-name');
        const inputMssv = document.getElementById('input-mssv');
        const playerNameDiv = document.getElementById('playerName');
        const playerMSSVDiv = document.getElementById('playerMSSV');
        const controls = document.getElementById('mobile-controls');
        
        // Quiz DOM Elements
        const quizOverlay = document.getElementById('quiz-overlay');
        const quizQuestion = document.getElementById('quiz-question');
        const quizOptionsDiv = document.getElementById('quiz-options');
        const quizOptionBtns = quizOptionsDiv.getElementsByClassName('quiz-option-btn');
        const quizExplanation = document.getElementById('quiz-explanation');
        const quizContinueBtn = document.getElementById('quiz-continue-btn');

        // Refs (Giữ nguyên)
        let currentLevelRef = null; 
        let currentMarioRef = null; 
        let currentQuestionBoxRef = null; 
        let currentCorrectAnswerIndex = -1;
        
        // Touch Device Check
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        // --- Hàm khởi tạo Game (QUAN TRỌNG) ---
        function initGame() {
            console.log("Initializing Game...");
            if (window.level && window.level.loop) {
                 window.level.pause(); // Dừng game cũ nếu có
                 console.log("Paused existing game loop.");
            }
            // Tạo đối tượng Level và gán vào biến toàn cục 'level'
            window.level = new Level('world'); 
            if (typeof definedLevels !== 'undefined' && definedLevels.length > 0) {
                 level.load(definedLevels[0]); // Tải màn chơi đầu tiên
                 level.start(); // Bắt đầu game loop
                 keys.bind(); // Kích hoạt input
                 console.log("Game initialized and started level 0.");

                 // Cập nhật tham chiếu sau khi game khởi tạo
                 currentLevelRef = level; 
                 currentMarioRef = level.figures.find(fig => fig instanceof Mario);
                 if (!currentMarioRef) { console.error("Mario instance not found after init!"); }

            } else {
                 console.error("definedLevels is not defined or empty! Cannot load level.");
                 alert("Lỗi: Không thể tải dữ liệu màn chơi!");
            }
        }


        // --- Login Handler ---
        loginButton.addEventListener('click', function() {
            const name = inputName.value.trim();
            const mssv = inputMssv.value.trim();
            if (name === '' || mssv === '') {
                loginScreen.classList.add('input-error');
                setTimeout(() => { loginScreen.classList.remove('input-error'); }, 300);
                return;
            }
            localStorage.setItem('playerName', name); localStorage.setItem('playerMSSV', mssv);
            playerNameDiv.textContent = name; playerMSSVDiv.textContent = mssv;
            
            loginScreen.style.opacity = '0'; 
            setTimeout(() => {
                 loginScreen.style.display = 'none'; 
                 gameDiv.classList.remove('hidden'); 
                 gameDiv.style.opacity = '1'; 
                 
                 // Gọi hàm khởi tạo game CHỈ KHI ĐĂNG NHẬP THÀNH CÔNG
                 initGame(); 
                 
                 // Phát nhạc nền
                 gameMusic.play().catch(e => console.warn("Audio play failed:", e)); 

                 if (isTouchDevice) {
                     controls.classList.remove('hidden'); 
                 }
                 
                 // Scale game
                 if (typeof scaleGame === 'function') {
                     scaleGame(); 
                     setTimeout(scaleGame, 50); 
                 } else {
                      console.warn("scaleGame function not found.");
                 }
                 
            }, 400); 
        });

        // --- Quiz Functions --- (Giữ nguyên logic)
        window.showQuiz = function(questionIndex, questionBoxRef) { /* ... */ };
        function handleAnswer(selectedIndex) { /* ... */ };
        window.hideQuiz = function() { /* ... */ };
        quizContinueBtn.onclick = hideQuiz;

        // --- Joystick --- (Giữ nguyên logic)
        function simulateKey(keyCode, eventType) { /* ... */ }
        if (isTouchDevice) { /* ... */ }

        // --- Game Over --- (Giữ nguyên logic)
        window.handleGameOver = function() { /* ... */ };
        
    }); // End DOMContentLoaded
    </script>
</body>
</html>

