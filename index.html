<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escape The Scam</title>
    <!-- ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n ƒë·∫øn style.css l√† ƒë√∫ng -->
    <link href="Content/style.css" rel="stylesheet" />
    <!-- ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n ƒë·∫øn favicon l√† ƒë√∫ng -->
    <link rel="icon" type="image/png" href="Content/favicon.png"> 
    <style>
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; touch-action: manipulation; }
        #game { image-rendering: pixelated; image-rendering: crisp-edges; }
    </style>
</head>
<body>

    <!-- Giao di·ªán Quiz Pop-up (Gi·ªØ nguy√™n HTML, CSS s·∫Ω x·ª≠ l√Ω) -->
    <div id="quiz-overlay" class="hidden">
        <div id="quiz-box">
            <p id="quiz-question">C√¢u h·ªèi?</p>
            <div id="quiz-options">
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
            </div>
            <p id="quiz-explanation" class="hidden"></p>
            <button id="quiz-continue-btn" class="hidden">Ti·∫øp t·ª•c</button>
        </div>
    </div>

    <!-- M√†n h√¨nh ƒêƒÉng nh·∫≠p (Gi·ªØ nguy√™n HTML) -->
    <div id="login-screen">
        <div id="login-container">
            <div id="login-info" class="login-column">
                <!-- ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n  ƒë√∫ng -->
                <img id="ueh-logo" src="Content/logo/KQM.png" alt="Logo" onerror="this.src='https://placehold.co/150x50/000000/0f0?text=Logo+Error'"> <!-- Th√™m fallback -->
                <h3>Lu·∫≠t Ch∆°i "Escape The Scam"</h3>
                <ul id="game-rules">
                    <li>D√πng ‚óÄ ‚ñ∂ / ph√≠m m≈©i t√™n ƒë·ªÉ di chuy·ªÉn.</li>
                    <li>D√πng ‚í∂ / ph√≠m L√™n ƒë·ªÉ nh·∫£y.</li>
                    <li>Tr√°nh 'Scammer'.</li>
                    <li>H√∫c v√†o h·ªôp [?] ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi.</li>
                    <li>Tr·∫£ l·ªùi sai s·∫Ω b·ªã tr·ª´ 1 m·∫°ng!</li>
                </ul>
            </div>
            <div id="login-box" class="login-column">
                <h2>V√†o Game</h2>
                <p>Nh·∫≠p th√¥ng tin (UEH Student)</p>
                <input type="text" id="input-name" placeholder="H·ªç v√† t√™n..." autocomplete="off">
                <input type="text" id="input-mssv" placeholder="MSSV..." autocomplete="off">
                <button id="login-button">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>
    </div>

    <!-- Game (Gi·ªØ nguy√™n HTML) -->
    <div id="game" class="hidden">
        <div id="world"></div>
        <div id="coinNumber" class="gauge">0</div>
        <div id="coin" class="gaugeSprite"></div>
        <div id="game-timer-display" class="gauge">10:00</div>
        <div id="liveNumber" class="gauge">0</div>
        <div id="live" class="gaugeSprite"></div>
        <div id="playerName" class="gauge gauge-text"></div>
        <div id="playerMSSV" class="gauge gauge-text"></div>
    </div>

    <!-- Penalty Notification -->
    <div id="penalty-notification" class="hidden">
        <p>‚ö†Ô∏è TR·∫¢ L·ªúI SAI!</p>
        <p>B·ªä TR·ª™ 2 PH√öT ‚è±Ô∏è</p>
    </div>

    <!-- Joystick (Gi·ªØ nguy√™n HTML) -->
    <div id="mobile-controls" class="hidden">
        <div id="dpad"> <button id="btn-left">‚óÄ</button> <button id="btn-right">‚ñ∂</button> </div>
        <div id="action-buttons"> <button id="btn-jump">‚í∂</button> </div>
    </div>

    <!-- Audio (Gi·ªØ nguy√™n HTML, ƒë·∫£m b·∫£o file nh·∫°c t·ªìn t·∫°i) -->
    <audio id="game-music" loop>
         <source src="Content/audio/background-music.mp3" type="audio/mpeg"> 
         Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ √¢m thanh.
    </audio>

    <!-- === TH·ª® T·ª∞ SCRIPT ƒê√É S·ª¨A === -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="Scripts/jQuery.js"><\/script>')</script>
    
    <script src="Scripts/oop.js"></script> <!-- Class.extend ph·∫£i ch·∫°y TR∆Ø·ªöC main.js -->
    <script src="Scripts/constants.js"></script> 
    <script src="Scripts/questions.js"></script> 
    
    <script src="Scripts/main.js"></script> <!-- Class game, c·∫ßn Class, questions, constants -->
    
    <script src="Scripts/testlevels.js"></script> <!-- D·ªØ li·ªáu m√†n ch∆°i, c·∫ßn c√°c Class trong main.js -->
    <script src="Scripts/keys.js"></script> <!-- X·ª≠ l√Ω Input -->
    <!-- ============================= -->

    <!-- Script ch√≠nh (Login, Quiz, Joystick, Game Over - Gi·ªØ nguy√™n logic) -->
    <script>
    // --- Khai b√°o bi·∫øn to√†n c·ª•c cho game ---
    var level = null; // Bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c kh·ªüi t·∫°o trong initGame

    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const gameDiv = document.getElementById('game');
        const gameMusic = document.getElementById('game-music'); 
        const inputName = document.getElementById('input-name');
        const inputMssv = document.getElementById('input-mssv');
        const playerNameDiv = document.getElementById('playerName');
        const playerMSSVDiv = document.getElementById('playerMSSV');
        const controls = document.getElementById('mobile-controls');
        
        // Quiz DOM Elements
        const quizOverlay = document.getElementById('quiz-overlay');
        const quizQuestion = document.getElementById('quiz-question');
        const quizOptionsDiv = document.getElementById('quiz-options');
        const quizOptionBtns = quizOptionsDiv.getElementsByClassName('quiz-option-btn');
        const quizExplanation = document.getElementById('quiz-explanation');
        const quizContinueBtn = document.getElementById('quiz-continue-btn');

        // Refs (Gi·ªØ nguy√™n)
        let currentLevelRef = null; 
        let currentMarioRef = null; 
        let currentQuestionBoxRef = null; 
        let currentCorrectAnswerIndex = -1;
        
        // Touch Device Check
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        // --- H√†m kh·ªüi t·∫°o Game (QUAN TR·ªåNG) ---
        function initGame() {
            console.log("Initializing Game...");
            if (window.level && window.level.loop) {
                 window.level.pause(); // D·ª´ng game c≈© n·∫øu c√≥
                 console.log("Paused existing game loop.");
            }
            // T·∫°o ƒë·ªëi t∆∞·ª£ng Level v√† g√°n v√†o bi·∫øn to√†n c·ª•c 'level'
            window.level = new Level('world'); 
            if (typeof definedLevels !== 'undefined' && definedLevels.length > 0) {
                 level.load(definedLevels[0]); // T·∫£i m√†n ch∆°i ƒë·∫ßu ti√™n
                 level.start(); // B·∫Øt ƒë·∫ßu game loop
                 keys.bind(); // K√≠ch ho·∫°t input
                 console.log("Game initialized and started level 0.");

                 // C·∫≠p nh·∫≠t tham chi·∫øu sau khi game kh·ªüi t·∫°o
                 currentLevelRef = level; 
                 currentMarioRef = level.figures.find(fig => fig instanceof Mario);
                 if (!currentMarioRef) { console.error("Mario instance not found after init!"); }

            } else {
                 console.error("definedLevels is not defined or empty! Cannot load level.");
                 alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu m√†n ch∆°i!");
            }
        }


        // --- Login Handler ---
        loginButton.addEventListener('click', function() {
            const name = inputName.value.trim();
            const mssv = inputMssv.value.trim();
            if (name === '' || mssv === '') {
                loginScreen.classList.add('input-error');
                setTimeout(() => { loginScreen.classList.remove('input-error'); }, 300);
                return;
            }
            localStorage.setItem('playerName', name); localStorage.setItem('playerMSSV', mssv);
            playerNameDiv.textContent = name; playerMSSVDiv.textContent = mssv;
            
            loginScreen.style.opacity = '0'; 
            setTimeout(() => {
                 loginScreen.style.display = 'none'; 
                 gameDiv.classList.remove('hidden'); 
                 gameDiv.style.opacity = '1'; 
                 
                 // G·ªçi h√†m kh·ªüi t·∫°o game CH·ªà KHI ƒêƒÇNG NH·∫¨P TH√ÄNH C√îNG
                 initGame();

                 // B·∫Øt ƒë·∫ßu timer
                 startGameTimer(); 
                 
                 // Ph√°t nh·∫°c n·ªÅn
                 gameMusic.play().catch(e => console.warn("Audio play failed:", e)); 

                 if (isTouchDevice) {
                     controls.classList.remove('hidden'); 
                 }
                 
                 // Scale game
                 if (typeof scaleGame === 'function') {
                     scaleGame(); 
                     setTimeout(scaleGame, 50); 
                 } else {
                      console.warn("scaleGame function not found.");
                 }
                 
            }, 400); 
        });

        // --- Timer System ---
        let gameTimeRemaining = 600; // 10 ph√∫t = 600 gi√¢y
        let timerInterval = null;
        const timerDisplay = document.getElementById('game-timer-display');

        function startGameTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                gameTimeRemaining--;
                updateTimerDisplay();

                if (gameTimeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleGameOver(false); // H·∫øt gi·ªù = thua
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameTimeRemaining / 60);
            const seconds = gameTimeRemaining % 60;
            if (timerDisplay) {
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // --- Penalty System ---
        const penaltyNotification = document.getElementById('penalty-notification');

        window.applyTimePenalty = function() {
            const PENALTY_SECONDS = 120; // 2 ph√∫t
            gameTimeRemaining -= PENALTY_SECONDS;

            if (gameTimeRemaining < 0) gameTimeRemaining = 0;
            updateTimerDisplay();

            // Hi·ªÉn th·ªã th√¥ng b√°o ph·∫°t
            if (penaltyNotification) {
                penaltyNotification.classList.remove('hidden');
                setTimeout(() => {
                    penaltyNotification.classList.add('hidden');
                }, 3000);
            }
        };

        // --- Quiz Functions ---
        window.showQuiz = function(questionIndex, questionBoxRef) {
            if (!gameQuestions || questionIndex < 0 || questionIndex >= gameQuestions.length) {
                console.error('Invalid question index:', questionIndex);
                return;
            }

            const question = gameQuestions[questionIndex];
            currentQuestionBoxRef = questionBoxRef;
            currentCorrectAnswerIndex = question.correct;

            // D·ª´ng game
            if (currentLevelRef) currentLevelRef.pause();
            if (currentMarioRef) currentMarioRef.setVelocity(0, 0);
            keys.reset();
            keys.unbind();

            // Hi·ªÉn th·ªã c√¢u h·ªèi
            quizQuestion.textContent = question.question;
            for (let i = 0; i < quizOptionBtns.length; i++) {
                if (question.options[i]) {
                    quizOptionBtns[i].textContent = question.options[i];
                    quizOptionBtns[i].classList.remove('hidden', 'correct', 'incorrect');
                    quizOptionBtns[i].disabled = false;
                    quizOptionBtns[i].onclick = () => handleAnswer(i);
                } else {
                    quizOptionBtns[i].classList.add('hidden');
                }
            }

            quizExplanation.classList.add('hidden');
            quizContinueBtn.classList.add('hidden');
            quizOverlay.classList.remove('hidden');
        };

        function handleAnswer(selectedIndex) {
            const question = gameQuestions[currentQuestionBoxRef ? currentQuestionBoxRef.questionIndex : 0];
            const isCorrect = selectedIndex === currentCorrectAnswerIndex;

            // Disable t·∫•t c·∫£ buttons
            for (let i = 0; i < quizOptionBtns.length; i++) {
                quizOptionBtns[i].disabled = true;
            }

            // Hi·ªÉn th·ªã ƒë√∫ng/sai
            quizOptionBtns[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                quizOptionBtns[currentCorrectAnswerIndex].classList.add('correct');
            }

            // Hi·ªÉn th·ªã gi·∫£i th√≠ch
            quizExplanation.textContent = question.explanation;
            quizExplanation.classList.remove('hidden');
            quizContinueBtn.classList.remove('hidden');

            // X·ª≠ l√Ω k·∫øt qu·∫£
            if (isCorrect) {
                if (currentMarioRef) currentMarioRef.addCoin();
            } else {
                // TR·∫¢ L·ªúI SAI: Tr·ª´ 1 m·∫°ng + Tr·ª´ 2 ph√∫t
                if (currentMarioRef) currentMarioRef.hurt();
                applyTimePenalty();
            }
        }

        window.hideQuiz = function() {
            quizOverlay.classList.add('hidden');

            // Ti·∫øp t·ª•c game
            if (currentLevelRef) currentLevelRef.start();
            keys.bind();
        };

        quizContinueBtn.onclick = hideQuiz;

        // --- Joystick --- (Gi·ªØ nguy√™n logic)
        function simulateKey(keyCode, eventType) { /* ... */ }
        if (isTouchDevice) { /* ... */ }

        // --- Game Over & Victory ---
        window.handleGameOver = function(victory = false) {
            console.log(victory ? 'Game Victory!' : 'Game Over!');

            // D·ª´ng timer
            if (timerInterval) clearInterval(timerInterval);

            // D·ª´ng game
            if (currentLevelRef) currentLevelRef.pause();
            keys.reset();
            keys.unbind();

            if (victory) {
                // Chi·∫øn th·∫Øng - Hi·ªÉn th·ªã m√†n h√¨nh ch·ª©ng nh·∫≠n
                showCertificate();
            } else {
                // Thua - Reload
                alert('Game Over! H·∫øt th·ªùi gian ho·∫∑c h·∫øt m·∫°ng.');
                window.location.reload();
            }
        };

        window.handleGameVictory = function() {
            handleGameOver(true);
        };

        function showCertificate() {
            const playerName = localStorage.getItem('playerName') || 'Ng∆∞·ªùi ch∆°i';
            const playerMSSV = localStorage.getItem('playerMSSV') || 'N/A';
            const timeElapsed = 600 - gameTimeRemaining;
            const minutes = Math.floor(timeElapsed / 60);
            const seconds = timeElapsed % 60;

            alert(`üéâ CH√öC M·ª™NG ${playerName}!\n\nB·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc!\nTh·ªùi gian: ${minutes}:${seconds.toString().padStart(2, '0')}\nMSSV: ${playerMSSV}`);
            window.location.reload();
        }
        
    }); // End DOMContentLoaded
    </script>
</body>
</html>

